<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nine Perspectives Result</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wellcoaches – Nine Perspectives</h1>
      <p class="subtitle">Comprehensive cognitive perspectives with synthesis</p>
    </div>


    <!-- ✅ Your Prompt -->
    <div class="card">
      <h2>Your Prompt</h2>
      <p class="input-text">{{escapedUserPrompt}}</p>

      <h2>
        Synthesis
        <button id="downloadWordBtn" class="button secondary" style="margin-left: 10px;">
          ⬇️ Export to Word
        </button>
      </h2>
      <div class="synthesis">{{claudeOutput}}</div>

      {{exploreSection}}
    </div>

    <!-- ✅ Perspectives -->
    <div id="perspectives-container" class="results"></div>

    <!-- ✅ Continue Reflection -->
    <div class="collaboration">
      <h2>Continue Your Reflection</h2>
      <form action="/ask" method="post">
        <input type="hidden" name="previous" value="{{escapedUserPrompt}}">
        <textarea name="prompt" rows="3" placeholder="Ask a follow-up question or go deeper..."></textarea>
        <div style="margin-top: 10px;">
          <label>
            <input type="checkbox" name="blindspot" value="true" /> Include blindspot analysis
          </label>
        </div>
        <button type="submit" class="button primary">Reflect Further →</button>
      </form>
    </div>

    <div class="reflection">
      <a href="/" class="button secondary">← Back</a>
    </div>

    <footer class="footer">
      Powered by GPT-5 + Claude 3.5 | © 2025 Wellcoaches.ai
    </footer>
  </div>

  <!-- ================================ -->
  <!-- Scripts -->
  <!-- ================================ -->
  <script>
  const perspectivesData = {{perspectivesJSON}};
  const blindspotData = {{blindspotData}};
  const showBlindspots = '{{showBlindspots}}';
  const container = document.getElementById('perspectives-container');

  // ✅ Render Perspectives
  if (Array.isArray(perspectivesData) && perspectivesData.length > 0) {
    perspectivesData.forEach((p) => {
      const div = document.createElement('div');
      div.classList.add('perspective');
      div.innerHTML = `
        <h3>${p.name}</h3>
        <p><strong>Insight:</strong> ${p.insight || "(No insight provided)"}</p>
        <p class="blindspot" style="display: ${showBlindspots};">
          <strong>Blind Spot:</strong> ${p.blindspot || "(Not applicable in this mode)"}
        </p>
        <button class="expand-btn" data-name="${p.name}">Deepen this Perspective</button>
        <div class="expand-output"></div>
      `;
      container.appendChild(div);
    });
  } else {
    const summaryBlock = document.createElement('div');
    summaryBlock.classList.add('summary-card');
    summaryBlock.innerHTML = `
      <h3>No Perspective Data</h3>
      <p>There was an issue loading the perspective data. Please try again.</p>
    `;
    container.appendChild(summaryBlock);
  }

  // ✅ Deepen Perspective Handler
  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('expand-btn')) {
      const button = e.target;
      const perspective = button.dataset.name;
      const prompt = "{{userPromptJS}}";
      const outputDiv = button.nextElementSibling;

      if (outputDiv.style.display === 'block') {
        outputDiv.style.display = 'none';
        return;
      }

      button.textContent = 'Loading...';
      try {
        const res = await fetch('/expand', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, perspective })
        });
        const data = await res.json();
        outputDiv.textContent = data.expanded || '(No response)';
        outputDiv.style.display = 'block';
      } catch {
        outputDiv.textContent = 'Error expanding perspective.';
        outputDiv.style.display = 'block';
      }
      button.textContent = 'Deepen this Perspective';
    }
  });

  // ✅ Export Synthesis to Word
  const downloadBtn = document.getElementById('downloadWordBtn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const synthesisDiv = document.querySelector('.synthesis');
      const content = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office'
              xmlns:w='urn:schemas-microsoft-com:office:word'
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Wellcoaches – Synthesis</title></head>
        <body><h1>Wellcoaches – Synthesis Summary</h1>${synthesisDiv.innerHTML}</body></html>`;
      const blob = new Blob(['\ufeff', content], { type: 'application/msword;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Wellcoaches_Synthesis.doc';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });
  }
  </script>
</body>
</html>
