<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nine Perspectives Result</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <div class="app-layout">
    <!-- ============================= -->
    <!-- üß≠ Sidebar - Reflections -->
    <!-- ============================= -->
    <aside class="sidebar">
      <h2>Your Reflections</h2>
      <div id="reflection-list"><p>Loading reflections...</p></div>
    </aside>

    <!-- ============================= -->
    <!-- üåø Main Content -->
    <!-- ============================= -->
    <main class="main-content">
      <h1>Wellcoaches ‚Äì Nine Perspectives</h1>
      <p class="subtitle">Comprehensive cognitive perspectives with synthesis</p>

      <!-- üß† Reflection Summary -->
      <div class="card">
        <h2>Your Prompt</h2>
        <p class="input-text">{{escapedUserPrompt}}</p>

        <h2>
          Synthesis
          <button id="downloadWordBtn" class="button secondary" style="margin-left:10px;">‚¨áÔ∏è Export to Word</button>
        </h2>
        <div class="synthesis">{{claudeOutput}}</div>
      </div>

      <!-- üß© Perspectives -->
      <div id="perspectives-container"></div>

      <!-- üîÑ Continue Reflection -->
      <div class="collaboration card">
        <h2>Continue Your Reflection</h2>
        <form action="/ask" method="post">
          <input type="hidden" name="previous" value="{{rawUserPrompt}}" />
          <input type="hidden" name="session_id" value="{{sessionId}}" />

          <textarea
            name="prompt"
            rows="3"
            placeholder="Ask a follow-up question or go deeper..."
            required
          ></textarea>

          <div class="options">
            <label>
              <input type="checkbox" name="blindspot" value="true" /> Include blindspot analysis
            </label>
          </div>

          <div class="buttons">
            <button type="submit" class="button primary">Reflect Further ‚Üí</button>
            <button type="submit" class="button secondary" name="reset" value="true">
              üß≠ Start New Reflection
            </button>
          </div>
        </form>
      </div>

      <footer class="footer">
        Powered by GPT-5 + Claude 3.5 | ¬© 2025 Wellcoaches.ai
      </footer>
    </main>
  </div>

  <!-- ============================= -->
  <!-- üí¨ Reflection Detail Modal -->
  <!-- ============================= -->
  <div id="reflectionModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2 id="modal-timestamp"></h2>
      <h3>Prompt</h3>
      <p id="modal-prompt"></p>
      <h3>Synthesis</h3>
      <div id="modal-synthesis" class="synthesis-card"></div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- üåø JS Logic -->
  <!-- ============================= -->
  <script>
    // ============================================================
    // 1Ô∏è‚É£ Render Perspectives
    // ============================================================
    const perspectivesData = JSON.parse(`{{perspectivesJSON}}`);
    const showBlindspots = "{{showBlindspots}}";
    const container = document.getElementById("perspectives-container");

    if (Array.isArray(perspectivesData) && perspectivesData.length > 0) {
      perspectivesData.forEach((p) => {
        const div = document.createElement("div");
        div.classList.add("perspective");
        div.innerHTML = `
          <h3>${p.name}</h3>
          <p><strong>Insight:</strong> ${p.insight || "(No insight provided)"}</p>
          <p class="blindspot" style="display:${showBlindspots};"><strong>Blind Spot:</strong> ${p.blindspot || "(Not applicable)"}</p>
          <button class="expand-btn" data-name="${p.name}">Deepen this Perspective</button>
          <div class="expand-output"></div>`;
        container.appendChild(div);
      });
    }

    // ============================================================
    // 2Ô∏è‚É£ Deepen Perspective Expansion
    // ============================================================
    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("expand-btn")) {
        const button = e.target;
        const perspective = button.dataset.name;
        const prompt = "{{userPromptJS}}";
        const outputDiv = button.nextElementSibling;

        button.textContent = "Loading...";
        try {
          const res = await fetch("/expand", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, perspective }),
          });
          const data = await res.json();
          outputDiv.textContent = data.expanded || "(No response)";
          outputDiv.style.display = "block";
        } catch {
          outputDiv.textContent = "Error expanding perspective.";
          outputDiv.style.display = "block";
        }
        button.textContent = "Deepen this Perspective";
      }
    });

    // ============================================================
    // 3Ô∏è‚É£ Load Reflection History (Sidebar)
    // ============================================================
    async function loadReflections() {
      const list = document.getElementById("reflection-list");
      const sessionId = localStorage.getItem("sessionId") || "{{sessionId}}";

      try {
        const res = await fetch(`/api/history?session_id=${sessionId}`);
        const data = await res.json();
        list.innerHTML = "";

        if (!data.success || !data.reflections.length) {
          list.innerHTML = "<p>No reflections yet.</p>";
          return;
        }

        // Sort newest ‚Üí oldest
        const reflections = data.reflections.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        reflections.forEach((r) => {
          const item = document.createElement("div");
          item.classList.add("reflection-item");
          item.innerHTML = `
            <p class="reflection-date">${r.timestamp}</p>
            <p class="reflection-preview">${r.prompt.slice(0, 60)}...</p>`;
          item.addEventListener("click", () => openReflectionModal(r));
          list.appendChild(item);
        });
      } catch (err) {
        console.error("Error loading reflections:", err);
        list.innerHTML = "<p>Failed to load reflections.</p>";
      }
    }

    // ============================================================
    // 4Ô∏è‚É£ Modal for Full Reflection View
    // ============================================================
    function openReflectionModal(reflection) {
      const modal = document.getElementById("reflectionModal");
      document.getElementById("modal-timestamp").textContent = reflection.timestamp;
      document.getElementById("modal-prompt").textContent = reflection.prompt;

      const formatted = reflection.synthesis
        .split(/\n{2,}/)
        .map((p) => `<p>${p.trim()}</p>`)
        .join("");
      document.getElementById("modal-synthesis").innerHTML = formatted;

      modal.style.display = "block";
    }

    document.querySelector(".close-btn").addEventListener("click", () => {
      document.getElementById("reflectionModal").style.display = "none";
    });
    window.addEventListener("click", (e) => {
      const modal = document.getElementById("reflectionModal");
      if (e.target === modal) modal.style.display = "none";
    });

    // ============================================================
    // 5Ô∏è‚É£ Inject New Reflection Immediately
    // ============================================================
    const newReflection = {{newReflection}};
    if (newReflection) {
      const list = document.getElementById("reflection-list");
      const item = document.createElement("div");
      item.classList.add("reflection-item");
      item.innerHTML = `
        <p class="reflection-date">${newReflection.timestamp}</p>
        <p class="reflection-preview">${newReflection.prompt.slice(0, 60)}...</p>`;
      item.addEventListener("click", () => openReflectionModal(newReflection));
      if (list.firstChild) list.insertBefore(item, list.firstChild);
      else list.appendChild(item);
    }

    // ============================================================
    // 6Ô∏è‚É£ Initialize Sidebar
    // ============================================================
    window.addEventListener("DOMContentLoaded", loadReflections);
  </script>
</body>
</html>
