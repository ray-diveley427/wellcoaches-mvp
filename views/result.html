<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nine Perspectives Result</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wellcoaches ‚Äì Nine Perspectives</h1>
      <p class="subtitle">Comprehensive cognitive perspectives with synthesis</p>
    </div>

    <div class="card">
      <h2>Your Prompt</h2>
      <p class="input-text">{{userPrompt}}</p>

      <h2>Synthesis</h2>
      <div class="synthesis">{{claudeOutput}}</div>

      {{exploreSection}}
    </div>

    <!-- Section where all perspectives are listed -->
    <div id="perspectives-container" class="results"></div>

    <div class="reflection">
      <a href="/" class="button secondary">‚Üê Back</a>
    </div>

    <footer class="footer">
      Powered by GPT-5 + Claude 3.5 | ¬© 2025 Wellcoaches.ai
    </footer>
  </div>

  <script>
  // -----------------------------------------------
  // Inject server-passed perspectives (if available)
  // -----------------------------------------------
  const perspectivesData = {{perspectivesJSON}};
  const blindspotData = {{blindspotData}};
  const showBlindspots = '{{showBlindspots}}';
  const container = document.getElementById('perspectives-container');

  console.log('‚úÖ Blindspot Data (raw):', blindspotData);
  console.log('üîç Client - perspectivesData:', perspectivesData);
  console.log('üîç Client - blindspotData:', blindspotData);
  console.log('üîç Client - showBlindspots:', showBlindspots);

  // -----------------------------------------------
  // Render Quick Blindspot Check results
  // -----------------------------------------------
  if (blindspotData && blindspotData.dominant) {
    const blindspotCard = document.createElement('div');
    blindspotCard.classList.add('card', 'synthesis'); // styled same as synthesis box

    blindspotCard.innerHTML = `
      <h2>Blindspot Insights</h2>

      <h3>Dominant Perspectives</h3>
      <p>${blindspotData.dominant.join(', ') || 'None identified'}</p>
      
      <h3>Missing Perspectives</h3>
      <p>${blindspotData.missing.join(', ') || 'None identified'}</p>
      
      ${
        blindspotData.dignity
          ? `<h3>Dignity Reminder</h3><p>${blindspotData.dignity}</p>`
          : ''
      }
    `;
    container.appendChild(blindspotCard);

    // ‚úÖ Add summary if available
    if (blindspotData.summary) {
      const summaryDiv = document.createElement('div');
      summaryDiv.classList.add('card');
      summaryDiv.innerHTML = `
        <h3>Summary</h3>
        <p>${blindspotData.summary}</p>
      `;
      container.appendChild(summaryDiv);
    }
  }
  // -----------------------------------------------
  // Render full 9-perspective view
  // -----------------------------------------------
  else if (Array.isArray(perspectivesData) && perspectivesData.length > 0) {
    perspectivesData.forEach((p) => {
      const div = document.createElement('div');
      div.classList.add('perspective');
      div.innerHTML = `
        <h3>${p.name}</h3>
        <p><strong>Insight:</strong> ${p.insight || "(No insight provided)"} </p>
        <p class="blindspot" style="display: ${showBlindspots};">
          <strong>Blind Spot:</strong> ${p.blindspot || "(Not applicable in this mode)"}
        </p>
        <button class="expand-btn" data-name="${p.name}">Deepen this Perspective</button>
        <div class="expand-output"></div>
      `;
      container.appendChild(div);
    });
  }
  // -----------------------------------------------
  // Render friendly message for edge cases
  // -----------------------------------------------
  else {
    const summaryBlock = document.createElement('div');
    summaryBlock.classList.add('summary-card');
    summaryBlock.innerHTML = `
      <h3>No Perspective Data</h3>
      <p>There was an issue loading the perspective data. Please try again.</p>
    `;
    container.appendChild(summaryBlock);
  }

  // -----------------------------------------------
  // Handle "Deepen this Perspective" interactions
  // -----------------------------------------------
  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('expand-btn')) {
      const button = e.target;
      const perspective = button.dataset.name;
      const prompt = "{{userPrompt}}";
      const outputDiv = button.nextElementSibling;

      if (outputDiv.style.display === 'block') {
        outputDiv.style.display = 'none';
        return;
      }

      button.textContent = 'Loading...';
      try {
        const res = await fetch('/expand', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, perspective })
        });
        const data = await res.json();
        outputDiv.textContent = data.expanded || '(No response)';
        outputDiv.style.display = 'block';
      } catch {
        outputDiv.textContent = 'Error expanding perspective.';
        outputDiv.style.display = 'block';
      }
      button.textContent = 'Deepen this Perspective';
    }
  });
</script>

</body>
</html>