<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nine Perspectives Result</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wellcoaches – Nine Perspectives</h1>
      <p class="subtitle">Comprehensive cognitive perspectives with synthesis</p>
    </div>

    <div class="card">
      <h2>Your Prompt</h2>
      <p class="input-text">{{userPrompt}}</p>

      <h2>Synthesis</h2>
      <div class="synthesis">{{claudeOutput}}</div>

      {{exploreSection}}
    </div>

    <!-- Section where all perspectives are listed -->
    <div id="perspectives-container" class="results"></div>

    <div class="reflection">
      <a href="/" class="button secondary">← Back</a>
    </div>

    <footer class="footer">
      Powered by GPT-5 + Claude 3.5 | © 2025 Wellcoaches.ai
    </footer>
  </div>

  <script>
    // -----------------------------------------------
    // Dynamically load and render perspectives
    // -----------------------------------------------
    async function loadPerspectives() {
      try {
        const response = await fetch('/logs/history.json');
        const text = await response.text();
        const entries = text.trim().split(',\n').filter(Boolean);
        if (entries.length === 0) return;

        // Last entry = latest request
        const lastEntry = JSON.parse(entries[entries.length - 1]);
        const gptResponsePath = lastEntry?.json_keys?.includes("perspectives") ? lastEntry : null;

        if (!gptResponsePath) return;

        // Optional: if you store full JSON responses, load from that file instead.
        // This example only shows static placeholder until you serve JSON directly.
      } catch (err) {
        console.warn("Could not load perspectives:", err);
      }
    }

    // -----------------------------------------------
    // Handle "Deepen this Perspective" interactions
    // -----------------------------------------------
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('expand-btn')) {
        const button = e.target;
        const perspective = button.dataset.name;
        const prompt = "{{userPrompt}}";
        const outputDiv = button.nextElementSibling;

        if (outputDiv.style.display === 'block') {
          outputDiv.style.display = 'none';
          return;
        }

        button.textContent = 'Loading...';
        try {
          const res = await fetch('/expand', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, perspective })
          });
          const data = await res.json();
          outputDiv.textContent = data.expanded || '(No response)';
          outputDiv.style.display = 'block';
        } catch {
          outputDiv.textContent = 'Error expanding perspective.';
          outputDiv.style.display = 'block';
        }
        button.textContent = 'Deepen this Perspective';
      }
    });

    // -----------------------------------------------
    // Inject server-passed perspectives (if available)
    // -----------------------------------------------
    const perspectivesData = {{perspectivesJSON}};
    const container = document.getElementById('perspectives-container');

    if (perspectivesData && perspectivesData.length > 0) {
      perspectivesData.forEach(p => {
        const div = document.createElement('div');
        div.classList.add('perspective');
        div.innerHTML = `
          <h3>${p.name}</h3>
          <p><strong>Insight:</strong> ${p.insight || "(No insight provided)"} </p>
          <p style="display: {{showBlindspots}};">
            <strong>Blind Spot:</strong> {{blindspot}}
          </p>
          <button class="expand-btn" data-name="${p.name}">Deepen this Perspective</button>
          <div class="expand-output"></div>
        `;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
