<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signing In - Multi-Perspective AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --purple-dark: #1e0a29;
      --purple-medium: #3b1050;
      --teal: #14b8a6;
      --teal-light: #5eead4;
      --teal-dark: #0d9488;
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --success: #10b981;
      --error: #ef4444;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, #ffffff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-primary);
    }

    .container {
      background: var(--bg-primary);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 3rem;
      max-width: 480px;
      width: 100%;
      text-align: center;
    }

    .logo {
      margin-bottom: 2rem;
    }

    .logo-text {
      font-size: 28px;
      font-weight: 500;
      color: var(--purple-dark);
      letter-spacing: -0.5px;
    }

    .logo-dash {
      color: var(--teal);
      font-weight: 600;
    }

    .logo-ai {
      color: var(--teal);
    }

    .spinner {
      width: 48px;
      height: 48px;
      margin: 0 auto 1.5rem;
      border: 4px solid var(--bg-secondary);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .status-message {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .success-state {
      display: none;
    }

    .success-state.visible {
      display: block;
    }

    .success-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .success-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }

    .error-state {
      display: none;
      color: var(--error);
    }

    .error-state.visible {
      display: block;
    }

    .error-state h2 {
      color: var(--error);
      margin-bottom: 1rem;
    }

    .error-state p {
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--teal);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--teal-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
    }

    .processing-state {
      display: block;
    }

    .processing-state.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <div class="logo-text">Multi<span class="logo-dash">‚Äî</span>Perspective <span class="logo-ai">AI</span></div>
    </div>

    <!-- Processing State -->
    <div class="processing-state" id="processingState">
      <div class="spinner"></div>
      <h2>Signing you in...</h2>
      <p class="status-message">Please wait while we complete your authentication.</p>
    </div>

    <!-- Success State -->
    <div class="success-state" id="successState">
      <div class="success-icon">
        <svg fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <h2>Success!</h2>
      <p class="status-message">You've been signed in successfully. Redirecting you now...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState">
      <h2>Authentication Failed</h2>
      <p id="errorMessage">An error occurred during sign-in.</p>
      <a href="/" class="btn">Return to Home</a>
    </div>
  </div>

  <script>
    // Wrap everything in an IIFE to allow early returns
    (function() {
      // --- Detect environment and set base URL ---
      function getBaseUrl() {
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;

        if (hostname.includes("localhost") || hostname.includes("127.0.0.1")) {
          // Local development
          return "http://localhost:3000";
        } else if (hostname.includes("multi-perspective.dev.wellcoachesschool.com")) {
          // Testing/staging environment
          return "https://multi-perspective.dev.wellcoachesschool.com";
        } else if (hostname.includes("multi-perspective.ai")) {
          // Production environment
          return "https://multi-perspective.ai";
        } else {
          // Fallback: use current origin
          return `${protocol}//${hostname}${window.location.port ? `:${window.location.port}` : ''}`;
        }
      }

      const baseUrl = getBaseUrl();
      const redirectUri = `${baseUrl}/callback.html`;
      const cognitoDomain = "https://us-east-1eucicqax3.auth.us-east-1.amazoncognito.com";
      const clientId = "7m3hp4bdldr9642grf15rhhp24";

      console.log("üîπ Callback URL:", window.location.href);
      console.log("üîπ Base URL:", baseUrl);
      console.log("üîπ Redirect URI:", redirectUri);

      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      // Check if Cognito returned an error
      if (error) {
        document.getElementById('processingState').classList.add('hidden');
        document.getElementById('errorState').classList.add('visible');

        let errorMsg = 'An error occurred during sign-in.';
        if (error === 'access_denied') {
          errorMsg = 'Sign-in was cancelled or access was denied.';
        } else if (errorDescription) {
          errorMsg = errorDescription;
        }

        document.getElementById('errorMessage').textContent = errorMsg;
        return;
      }

      if (!code) {
        // Show error state - no code received
        document.getElementById('processingState').classList.add('hidden');
        document.getElementById('errorState').classList.add('visible');
        document.getElementById('errorMessage').textContent = 'No authorization code received. Please try signing in again.';
      } else {
        console.log("‚úÖ Code received");

        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        fetch(`${cognitoDomain}/oauth2/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: clientId,
            code: code,
            redirect_uri: redirectUri
          }),
          signal: controller.signal
        })
        .then(async r => {
          clearTimeout(timeoutId); // Clear timeout on success
          const text = await r.text();
          console.log("Response:", r.status, text);
          if (!r.ok) throw new Error(text);
          return JSON.parse(text);
        })
        .then(tokens => {
          console.log("‚úÖ Tokens received!");
          localStorage.setItem("id_token", tokens.id_token);
          localStorage.setItem("access_token", tokens.access_token);
          if (tokens.refresh_token) localStorage.setItem("refresh_token", tokens.refresh_token);

          // Show success state
          document.getElementById('processingState').classList.add('hidden');
          document.getElementById('successState').classList.add('visible');

          // Redirect after showing success message
          setTimeout(() => {
            window.location.href = `${baseUrl}/`;
          }, 1500);
        })
        .catch(e => {
          clearTimeout(timeoutId); // Clear timeout on error
          console.error("‚ùå Error:", e);

          // Show error state
          document.getElementById('processingState').classList.add('hidden');
          document.getElementById('errorState').classList.add('visible');

          // Parse error message for user-friendly display
          let errorMsg = 'An unexpected error occurred. Please try again.';

          // Handle timeout
          if (e.name === 'AbortError') {
            errorMsg = 'Sign-in is taking too long. Please check your connection and try again.';
          } else {
            try {
              // Try to parse JSON error from Cognito
              const errorJson = JSON.parse(e.message);

              if (errorJson.error === 'unauthorized_client' && errorJson.error_description?.includes('invalid_redirect')) {
                errorMsg = 'We are having trouble signing you in. Please contact support for assistance.';
              } else if (errorJson.error === 'invalid_grant') {
                errorMsg = 'Your sign-in session has expired. Please try signing in again.';
              } else if (errorJson.error === 'invalid_client') {
                errorMsg = 'We are having trouble signing you in. Please contact support for assistance.';
              } else if (errorJson.error_description) {
                errorMsg = errorJson.error_description;
              }
            } catch (parseError) {
              // Not JSON or couldn't parse, use original message
              if (e.message && !e.message.includes('{')) {
                errorMsg = e.message;
              }
            }
          }

          document.getElementById('errorMessage').textContent = errorMsg;
        });
      }
    })(); // End of IIFE
  </script>
</body>
</html>