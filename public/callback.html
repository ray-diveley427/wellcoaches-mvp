<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Completing login...</title>
</head>
<body>
  <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
    <h2>Completing login...</h2>
    <p>Please wait...</p>
  </div>

  <script>
    // --- Detect environment and set base URL ---
    function getBaseUrl() {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      
      if (hostname.includes("localhost") || hostname.includes("127.0.0.1")) {
        // Local development
        return "http://localhost:3000";
      } else if (hostname.includes("multi-perspective.dev.wellcoachesschool.com")) {
        // Testing/staging environment
        return "https://multi-perspective.dev.wellcoachesschool.com";
      } else if (hostname.includes("multi-perspective.ai")) {
        // Production environment
        return "https://multi-perspective.ai";
      } else {
        // Fallback: use current origin
        return `${protocol}//${hostname}${window.location.port ? `:${window.location.port}` : ''}`;
      }
    }
    
    const baseUrl = getBaseUrl();
    const redirectUri = `${baseUrl}/callback.html`;
    const cognitoDomain = "https://us-east-1eucicqax3.auth.us-east-1.amazoncognito.com";
    const clientId = "7m3hp4bdldr9642grf15rhhp24";
    
    console.log("üîπ Callback URL:", window.location.href);
    console.log("üîπ Base URL:", baseUrl);
    console.log("üîπ Redirect URI:", redirectUri);
    
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    
    if (!code) {
      document.body.innerHTML = `<p style="color:red;">No code. <a href="${baseUrl}/">Try again</a></p>`;
    } else {
      console.log("‚úÖ Code received");
      
      fetch(`${cognitoDomain}/oauth2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          client_id: clientId,
          code: code,
          redirect_uri: redirectUri
        })
      })
      .then(async r => {
        const text = await r.text();
        console.log("Response:", r.status, text);
        if (!r.ok) throw new Error(text);
        return JSON.parse(text);
      })
      .then(tokens => {
        console.log("‚úÖ Tokens received!");
        localStorage.setItem("id_token", tokens.id_token);
        localStorage.setItem("access_token", tokens.access_token);
        if (tokens.refresh_token) localStorage.setItem("refresh_token", tokens.refresh_token);
        
        document.body.innerHTML = '<h2 style="color:green; text-align:center;">‚úÖ Success! Redirecting...</h2>';
        setTimeout(() => window.location.href = `${baseUrl}/`, 1000);
      })
      .catch(e => {
        console.error("‚ùå Error:", e);
        document.body.innerHTML = `<div style="padding:20px;"><h2>Failed</h2><p style="color:red;">${e.message}</p><a href="${baseUrl}/">Try again</a></div>`;
      });
    }
  </script>
</body>
</html>